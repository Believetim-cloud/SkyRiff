# SkyRiff å¼€å‘ä¼˜å…ˆçº§æ¸…å•ï¼ˆç¨‹åºå°ç™½ç‰ˆï¼‰v1.0

> **ç›®æ ‡**ï¼šæŒ‰é˜¶æ®µæ¨è¿›ï¼Œæ¯ä¸ªé˜¶æ®µéƒ½èƒ½çœ‹åˆ°æˆæœï¼Œä¸ä¼šåŠè·¯å´©æºƒ

---

## Phase 0ï¼šåŸºç¡€è®¾æ–½ï¼ˆ1-2å¤©ï¼‰âš™ï¸

### ç›®æ ‡
æ‰“åœ°åŸºï¼Œåé¢æ‰€æœ‰åŠŸèƒ½éƒ½èƒ½è·‘é€š

### ä½ ä¼šçœ‹åˆ°çš„æˆæœ
âœ… èƒ½ç™»å½•
âœ… èƒ½çœ‹åˆ°ä½™é¢
âœ… èƒ½çœ‹åˆ°é…ç½®å’Œ"ç©ºé¡µé¢"

### å¼€å‘ä»»åŠ¡æ¸…å•

#### 1. ç”¨æˆ·ç™»å½•ç³»ç»Ÿ
- [ ] **æ‰‹æœºéªŒè¯ç ç™»å½•ï¼ˆå¿…åšï¼‰**
  - [ ] å‘é€éªŒè¯ç æ¥å£ï¼š`POST /auth/sms/send`
  - [ ] éªŒè¯ç ç™»å½•æ¥å£ï¼š`POST /auth/sms/verify`
  - [ ] è¿”å›JWT Token
  - [ ] å‰ç«¯å­˜å‚¨Token
- [ ] **å¾®ä¿¡ç™»å½•ï¼ˆå¯ååšï¼Œä½†å»ºè®®å°½æ—©ï¼‰**
  - [ ] å¾®ä¿¡ç™»å½•åˆå§‹åŒ–ï¼š`POST /auth/wechat/init`
  - [ ] å¾®ä¿¡ç™»å½•å›è°ƒï¼š`POST /auth/wechat/callback`
  - [ ] è¿”å›JWT Token
- [ ] **Tokenä½“ç³»**
  - [ ] JWTç”Ÿæˆä¸éªŒè¯
  - [ ] Tokenè¿‡æœŸæ—¶é—´ï¼š7å¤©
  - [ ] Refresh Tokenï¼š30å¤©

#### 2. ä¸‰é’±åŒ…åŸºç¡€
- [ ] **Creditsé’±åŒ…ï¼ˆç§¯åˆ†ï¼‰**
  - [ ] åˆ›å»º`credit_wallets`è¡¨
  - [ ] åˆ›å»º`credit_ledgers`æµæ°´è¡¨
  - [ ] æŸ¥è¯¢ä½™é¢æ¥å£ï¼š`GET /me/wallets`
  - [ ] æŸ¥è¯¢æµæ°´æ¥å£ï¼š`GET /wallet/ledgers?type=credits`
- [ ] **Coinsé’±åŒ…ï¼ˆé‡‘å¸ï¼‰**
  - [ ] åˆ›å»º`coin_wallets`è¡¨ï¼ˆåŒ…å«availableå’Œpendingå­—æ®µï¼‰
  - [ ] åˆ›å»º`coin_ledgers`æµæ°´è¡¨ï¼ˆåŒ…å«unlock_atå­—æ®µï¼‰
  - [ ] æŸ¥è¯¢ä½™é¢æ¥å£ï¼š`GET /me/wallets`
  - [ ] æŸ¥è¯¢æµæ°´æ¥å£ï¼š`GET /wallet/ledgers?type=coins`
- [ ] **åŸºæœ¬æµæ°´æŸ¥è¯¢**
  - [ ] æŒ‰ç±»å‹ç­›é€‰ï¼ˆcredits/coinsï¼‰
  - [ ] åˆ†é¡µæŸ¥è¯¢
  - [ ] æ˜¾ç¤ºä½™é¢å˜åŒ–

#### 3. äº§å“é…ç½®
- [ ] **å……å€¼æ¡£ä½é…ç½®ï¼ˆå†™æ­»åˆ°æ•°æ®åº“ï¼‰**
  - [ ] åˆ›å»º`products`è¡¨
  - [ ] æ’å…¥å……å€¼æ¡£ä½æ•°æ®ï¼ˆ6å…ƒ120ç§¯åˆ†ã€30å…ƒ600ç§¯åˆ†...ï¼‰
  - [ ] æ’å…¥æœˆå¡å•†å“ï¼ˆ29å…ƒï¼‰
- [ ] **æ‰“èµæ¡£ä½é…ç½®**
  - [ ] å†™æ­»ï¼š10/20/50/100ç§¯åˆ†
- [ ] **ç³»ç»Ÿå¸¸é‡é…ç½®ï¼ˆå¯å†™åˆ°configæ–‡ä»¶ï¼‰**
  - [ ] ç”Ÿæˆè´¹ç”¨ï¼š10ç§’=10ã€15ç§’=15ã€25ç§’=25
  - [ ] æ— æ°´å°ä¸‹è½½ï¼š6ç§¯åˆ†
  - [ ] æç¤ºè¯è§£é”ï¼š5ç§¯åˆ†
  - [ ] äºŒåˆ›è´¹ç”¨ï¼š2ç§¯åˆ†
  - [ ] å¹³å°æŠ½æˆï¼šåˆ›ä½œæ”¶ç›Š10%ã€å•†å•5%
  - [ ] å†»ç»“å¤©æ•°ï¼š7å¤©
  - [ ] æœˆå¡é¢†å–ï¼š30ç§¯åˆ†/å¤©
  - [ ] ä»»åŠ¡å¥–åŠ±ï¼š2ç§¯åˆ†/ä¸ª

### éªŒæ”¶æ ‡å‡†
- âœ… æ‰‹æœºå·èƒ½æ”¶åˆ°éªŒè¯ç 
- âœ… è¾“å…¥éªŒè¯ç èƒ½ç™»å½•æˆåŠŸ
- âœ… ç™»å½•åèƒ½çœ‹åˆ°Token
- âœ… å…³é—­APPå†æ‰“å¼€ï¼Œä»ä¿æŒç™»å½•æ€
- âœ… æˆ‘çš„é¡µèƒ½æ˜¾ç¤ºï¼šç§¯åˆ†0ã€é‡‘å¸0.00
- âœ… èƒ½æŸ¥è¯¢åˆ°ç©ºçš„æµæ°´è®°å½•

---

## Phase 1ï¼šæ ¸å¿ƒé—­ç¯MVPï¼ˆ3-7å¤©ï¼‰ğŸ¬

### ç›®æ ‡
ç”¨æˆ·èƒ½ç”Ÿæˆè§†é¢‘ â†’ èµ„äº§èƒ½çœ‹åˆ° â†’ èƒ½ä¸‹è½½ï¼ˆæ°´å°/æ— æ°´å°æ‰£ç§¯åˆ†ï¼‰

### ä½ ä¼šçœ‹åˆ°çš„æˆæœ
âœ… ç”¨æˆ·èƒ½çœŸå®ç”Ÿæˆè§†é¢‘
âœ… äº§å“"æ´»äº†"

### å¼€å‘ä»»åŠ¡æ¸…å•

#### 1. åˆ›ä½œåŠŸèƒ½ï¼ˆæ–‡ç”Ÿ+å›¾ç”Ÿï¼‰
- [ ] **ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰**
  - [ ] ä¸Šä¼ æ¥å£ï¼š`POST /media/upload`
  - [ ] è¿”å›`asset_id`å’Œ`url`
  - [ ] å›¾ç‰‡å­˜å‚¨åˆ°OSS
- [ ] **åˆ›å»ºç”Ÿæˆä»»åŠ¡**
  - [ ] æ¥å£ï¼š`POST /tasks/create`
  - [ ] å‚æ•°ï¼špromptã€duration_secã€ratioã€modelã€project_idã€reference_image_asset_id
  - [ ] **é¢„æ‰£ç§¯åˆ†é€»è¾‘ï¼ˆå…³é”®ï¼‰**ï¼š
    ```python
    cost = duration_sec  # 10/15/25
    if credits_balance < cost:
        raise InsufficientCredits
    
    # é¢„æ‰£ç§¯åˆ†
    credit_wallet.balance -= cost
    credit_ledger.create(type="gen_hold", amount=-cost)
    
    # åˆ›å»ºä»»åŠ¡
    task = Task.create(status="QUEUED", cost_credits=cost)
    ```
  - [ ] è°ƒç”¨ä¾›åº”å•†APIåˆ›å»ºä»»åŠ¡
  - [ ] è¿”å›`task_id`

#### 2. ä»»åŠ¡é˜Ÿåˆ—ä¸è½®è¯¢
- [ ] **æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€**
  - [ ] æ¥å£ï¼š`GET /tasks/{task_id}`
  - [ ] è¿”å›ï¼šstatusã€progressã€video_idï¼ˆæˆåŠŸåï¼‰
- [ ] **ä»»åŠ¡åˆ—è¡¨**
  - [ ] æ¥å£ï¼š`GET /tasks?status=&cursor=`
  - [ ] æŒ‰çŠ¶æ€ç­›é€‰ï¼šALL/QUEUED/IN_PROGRESS/SUCCESS/FAILURE
- [ ] **è½®è¯¢æœºåˆ¶**
  - [ ] å‰ç«¯æ¯5ç§’è½®è¯¢ä¸€æ¬¡`GET /tasks/{task_id}`
  - [ ] ç›´åˆ°status=SUCCESSæˆ–FAILURE
- [ ] **Celeryå¼‚æ­¥ä»»åŠ¡ï¼ˆåç«¯ï¼‰**
  - [ ] åˆ›å»ºCelery worker
  - [ ] å®šæ—¶è½®è¯¢ä¾›åº”å•†ä»»åŠ¡çŠ¶æ€
  - [ ] çŠ¶æ€æ˜ å°„ï¼šcompletedâ†’SUCCESSã€failedâ†’FAILURE

#### 3. ä»»åŠ¡æˆåŠŸ/å¤±è´¥å¤„ç†
- [ ] **æˆåŠŸå¤„ç†**
  - [ ] ä»ä¾›åº”å•†è·å–`video_url`
  - [ ] åˆ›å»º`VideoAsset`è®°å½•ï¼š
    ```python
    VideoAsset.create(
        owner_user_id=user_id,
        task_id=task_id,
        watermarked_play_url=video_url,  # æ°´å°ç‰ˆ
        source_no_wm_url=video_url,      # æ— æ°´å°æºï¼ˆåç«¯ä»£ç†ï¼‰
        publish_status="draft"
    )
    ```
  - [ ] ä»»åŠ¡çŠ¶æ€æ›´æ–°ä¸ºSUCCESS
  - [ ] **é¢„æ‰£ç§¯åˆ†è½¬ä¸ºæ­£å¼æ‰£é™¤**ï¼ˆæˆ–ç›´æ¥è§†ä¸ºå·²æ‰£é™¤ï¼‰
- [ ] **å¤±è´¥å¤„ç†ï¼ˆå…³é”®ï¼‰**
  - [ ] ä»»åŠ¡çŠ¶æ€æ›´æ–°ä¸ºFAILURE
  - [ ] **è‡ªåŠ¨é€€å›é¢„æ‰£ç§¯åˆ†**ï¼š
    ```python
    credit_wallet.balance += task.cost_credits
    credit_ledger.create(type="gen_refund", amount=+task.cost_credits)
    ```
  - [ ] è®°å½•å¤±è´¥åŸå› `error_message`

#### 4. è§†é¢‘èµ„äº§é¡µ
- [ ] **è§†é¢‘èµ„äº§åˆ—è¡¨**
  - [ ] æ¥å£ï¼š`GET /assets/videos?project_id=&cursor=`
  - [ ] è¿”å›ï¼švideo_idã€watermarked_play_urlã€thumbnail_urlã€durationã€ratioã€publish_statusã€created_at
  - [ ] æŒ‰é¡¹ç›®ç­›é€‰ï¼ˆproject_idå¯ç©ºï¼‰
  - [ ] åˆ†é¡µæŸ¥è¯¢
- [ ] **è§†é¢‘æ’­æ”¾é¢„è§ˆ**
  - [ ] æ°´å°ç‰ˆå…è´¹æ’­æ”¾
  - [ ] å…¨å±æ’­æ”¾å™¨ï¼ˆç±»ä¼¼æŠ–éŸ³ï¼‰
  - [ ] ç‚¹å‡»æš‚åœ/æ’­æ”¾
- [ ] **æ— æ°´å°ä¸‹è½½ï¼ˆé‡ç‚¹ï¼‰**
  - [ ] æ¥å£ï¼š`POST /assets/videos/{video_id}/download_no_watermark`
  - [ ] **æƒé™æ ¡éªŒï¼ˆå¿…é¡»ï¼‰**ï¼š
    ```python
    if video.owner_user_id != current_user_id:
        raise PermissionDenied("åªèƒ½ä¸‹è½½è‡ªå·±çš„è§†é¢‘")
    ```
  - [ ] **æ‰£è´¹6ç§¯åˆ†**ï¼š
    ```python
    credit_wallet.balance -= 6
    credit_ledger.create(type="download_spend", amount=-6)
    ```
  - [ ] **è¿”å›ä¸´æ—¶ç­¾åURLï¼ˆ1å°æ—¶æœ‰æ•ˆï¼‰**
  - [ ] **ä¸è¿”å›ç›´é“¾ï¼ˆå®‰å…¨ï¼‰**

#### 5. é¡¹ç›®ç®¡ç†
- [ ] **é¡¹ç›®åˆ—è¡¨**
  - [ ] æ¥å£ï¼š`GET /projects`
  - [ ] è¿”å›ï¼šproject_idã€nameã€video_countã€created_at
- [ ] **åˆ›å»ºé¡¹ç›®**
  - [ ] æ¥å£ï¼š`POST /projects`
  - [ ] å‚æ•°ï¼šname
- [ ] **é‡å‘½åé¡¹ç›®**
  - [ ] æ¥å£ï¼š`PATCH /projects/{project_id}`
  - [ ] å‚æ•°ï¼šname
- [ ] **åˆ é™¤é¡¹ç›®ï¼ˆå¯é€‰ï¼‰**
  - [ ] é¡¹ç›®ä¸‹è§†é¢‘ä¸åˆ é™¤ï¼Œç§»åˆ°"æœªåˆ†ç±»"

#### 6. ä¾›åº”å•†å¯¹æ¥ï¼ˆSora2 APIï¼‰
- [ ] **DyuAPI Adapterå±‚**
  - [ ] æ–‡ä»¶ï¼š`backend/app/vendors/dyuapi_sora2.py`
  - [ ] æ–¹æ³•ï¼š
    ```python
    class DyuSora2Adapter:
        def create_text2video(prompt, duration, ratio, tier, hd) -> VendorCreateResult
        def create_image2video_upload(prompt, duration, ratio, image_bytes, tier, hd) -> VendorCreateResult
        def get_task_state(vendor_id) -> VendorTaskState
        def _select_model_and_size(duration, ratio, tier, hd) -> (model, size)
    ```
- [ ] **çŠ¶æ€æ˜ å°„**
  - [ ] created/not_start â†’ NOT_START
  - [ ] queued/pending â†’ QUEUED
  - [ ] processing/in_progress â†’ IN_PROGRESS
  - [ ] completed/success â†’ SUCCESS
  - [ ] failed/error â†’ FAILURE

### éªŒæ”¶æ ‡å‡†
- âœ… èƒ½åˆ›å»ºæ–‡ç”Ÿä»»åŠ¡ï¼ˆåªå¡«promptï¼‰
- âœ… èƒ½åˆ›å»ºå›¾ç”Ÿä»»åŠ¡ï¼ˆä¸Šä¼ å›¾ç‰‡+promptï¼‰
- âœ… åˆ›å»ºä»»åŠ¡åç§¯åˆ†ç«‹å³å‡å°‘ï¼ˆé¢„æ‰£ï¼‰
- âœ… ä»»åŠ¡ä»QUEUED â†’ IN_PROGRESS â†’ SUCCESSå˜åŒ–
- âœ… ç”ŸæˆæˆåŠŸåï¼Œèµ„äº§é¡µèƒ½çœ‹åˆ°æ–°è§†é¢‘
- âœ… èƒ½æ’­æ”¾æ°´å°ç‰ˆè§†é¢‘
- âœ… èƒ½æ‰£6ç§¯åˆ†ä¸‹è½½æ— æ°´å°ç‰ˆï¼ˆä»…é™æœ¬äººï¼‰
- âœ… ç”Ÿæˆå¤±è´¥åç§¯åˆ†è‡ªåŠ¨é€€å›

---

## Phase 2ï¼šå†…å®¹å¢é•¿ï¼ˆ7-14å¤©ï¼‰ğŸ“ˆ

### ç›®æ ‡
æœ‰å†…å®¹æµã€æœ‰äº’åŠ¨ã€æœ‰åˆ›ä½œè€…æ”¶ç›Š

### ä½ ä¼šçœ‹åˆ°çš„æˆæœ
âœ… å†…å®¹å¼€å§‹è‡ªå¢é•¿
âœ… åˆ›ä½œè€…æœ‰åŠ¨åŠ›å‘ä½œå“

### å¼€å‘ä»»åŠ¡æ¸…å•

#### 1. å‘å¸ƒä½œå“
- [ ] **å‘å¸ƒæ¥å£**
  - [ ] `POST /works/publish`
  - [ ] å‚æ•°ï¼švideo_idã€titleã€descriptionã€is_prompt_lockedã€prompt_price_creditsã€remix_fee_credits
  - [ ] åˆ›å»ºWorkè®°å½•ï¼š
    ```python
    Work.create(
        video_id=video_id,
        creator_user_id=user_id,
        title=title,
        description=description,
        prompt_text=task.prompt_final,  # ä»ä»»åŠ¡è¯»å–
        is_prompt_locked=True,
        prompt_price_credits=5,
        remix_fee_credits=2,
        status="published",
        share_link=f"https://skyriff.com/works/{work_id}"
    )
    ```
  - [ ] æ›´æ–°VideoAssetï¼š`publish_status="published"`
  - [ ] **è‡ªåŠ¨è®¾ç½®ç”¨æˆ·ä¸ºåˆ›ä½œè€…**ï¼š`user.is_creator=True`
- [ ] **ä½œå“ç»Ÿè®¡è¡¨åˆå§‹åŒ–**
  - [ ] åˆ›å»ºWorkStatsè®°å½•ï¼šlike_count=0ã€favorite_count=0ã€tip_count=0ã€share_count=0ã€views=0

#### 2. é¦–é¡µFeed
- [ ] **å‘ç°é¡µï¼ˆæ™ºèƒ½æ¨èï¼‰**
  - [ ] æ¥å£ï¼š`GET /feed?tab=discover&cursor=&limit=20`
  - [ ] åŸºç¡€ç®—æ³•ï¼ˆv1ï¼‰ï¼š
    ```python
    score = (likes Ã— 1.0) + (favorites Ã— 2.0) + (tips Ã— 5.0) + (shares Ã— 3.0)
    order by score DESC, created_at DESC
    ```
  - [ ] è¿”å›Workåˆ—è¡¨ï¼ˆå¸¦creatorä¿¡æ¯ã€ç»Ÿè®¡æ•°æ®ï¼‰
- [ ] **çƒ­é—¨é¡µï¼ˆ24å°æ—¶çƒ­æ¦œï¼‰**
  - [ ] æ¥å£ï¼š`GET /feed?tab=hot&cursor=&limit=20`
  - [ ] ç­›é€‰ï¼šcreated_at >= now() - 24h
  - [ ] æ’åºï¼šorder by like_count DESC
- [ ] **æ’è¡Œé¡µï¼ˆåˆ›ä½œè€…æ‰“èµæ’è¡ŒTop10ï¼‰**
  - [ ] æ¥å£ï¼š`GET /rankings/creators/tips?limit=10`
  - [ ] ç»Ÿè®¡ï¼šç´¯è®¡æ”¶åˆ°çš„æ‰“èµç§¯åˆ†
  - [ ] è¿”å›ï¼šrankã€user_idã€nicknameã€avatar_urlã€total_tipped_creditsã€followers_count

#### 3. å…³æ³¨ç³»ç»Ÿ
- [ ] **å…³æ³¨/å–å…³**
  - [ ] `POST /users/{user_id}/follow`
  - [ ] `POST /users/{user_id}/unfollow`
  - [ ] åˆ›å»º/åˆ é™¤Followè®°å½•
  - [ ] æ›´æ–°UserStatsï¼šfollowers_countã€following_count
- [ ] **ç”¨æˆ·ä¸»é¡µ**
  - [ ] æ¥å£ï¼š`GET /users/{user_id}/profile`
  - [ ] è¿”å›ï¼šuser_basicã€statsï¼ˆè·èµã€ç²‰ä¸ã€å…³æ³¨ã€ä½œå“æ•°ï¼‰ã€is_following
  - [ ] æ¥å£ï¼š`GET /users/{user_id}/works?cursor=`
  - [ ] è¿”å›ï¼šç”¨æˆ·çš„å…¬å¼€ä½œå“åˆ—è¡¨ï¼ˆå¸¦like_countï¼‰

#### 4. æ‰“èµå¹¶æ”¶è—ï¼ˆæ ¸å¿ƒå˜ç°ï¼‰
- [ ] **æ‰“èµå¹¶æ”¶è—æ¥å£**
  - [ ] `POST /works/{work_id}/tip_and_favorite`
  - [ ] å‚æ•°ï¼šamount_creditsï¼ˆä»…å…è®¸10/20/50/100ï¼‰
  - [ ] **æ‰£è´¹é€»è¾‘**ï¼š
    ```python
    # 1. æ‰£ä»˜è´¹è€…ç§¯åˆ†
    credit_wallet.balance -= amount_credits
    credit_ledger.create(type="tip_spend", amount=-amount_credits)
    
    # 2. å¹³å°æŠ½æˆ10%
    platform_coins = amount_credits * 0.1 * 0.05  # è½¬é‡‘å¸æ±‡ç‡1ç§¯åˆ†=0.05coin
    
    # 3. åˆ›ä½œè€…æ”¶å…¥90%ï¼Œå†»ç»“7å¤©
    creator_coins = amount_credits * 0.9 * 0.05
    coin_wallet.pending_coins += creator_coins
    coin_ledger.create(
        type="creator_tip_income",
        amount_coins=creator_coins,
        source_user_id=payer_user_id,
        status="pending",
        unlock_at=now() + 7days
    )
    
    # 4. æ”¶è—ä½œå“
    if not Favorite.exists(user_id, work_id):
        Favorite.create(user_id, work_id)
    ```
  - [ ] æ›´æ–°WorkStatsï¼štip_count++ã€favorite_count++ï¼ˆå¦‚æœæ˜¯æ–°æ”¶è—ï¼‰
- [ ] **ä½œå“è¯¦æƒ…é¡µæ˜¾ç¤º**
  - [ ] like_countã€favorite_countã€tip_countã€share_countã€views

#### 5. æç¤ºè¯è§£é”
- [ ] **è§£é”æ¥å£**
  - [ ] `POST /works/{work_id}/prompt/unlock`
  - [ ] **æ£€æŸ¥æ˜¯å¦å·²è§£é”**ï¼š
    ```python
    if PromptUnlock.exists(user_id, work_id):
        return {"prompt_text": work.prompt_text, "cost_credits": 0}
    ```
  - [ ] **æ‰£è´¹5ç§¯åˆ†**ï¼š
    ```python
    credit_wallet.balance -= 5
    credit_ledger.create(type="paid_prompt_spend", amount=-5)
    
    # åˆ›ä½œè€…æ”¶å…¥90%ï¼Œå†»ç»“7å¤©
    creator_coins = 5 * 0.9 * 0.05
    coin_ledger.create(
        type="creator_prompt_income",
        amount_coins=creator_coins,
        status="pending",
        unlock_at=now() + 7days
    )
    
    # è®°å½•è§£é”
    PromptUnlock.create(user_id, work_id, paid_credits=5)
    ```
- [ ] **æŸ¥çœ‹æç¤ºè¯æ¥å£**
  - [ ] `GET /works/{work_id}/prompt`
  - [ ] å·²è§£é”ï¼šè¿”å›prompt_text
  - [ ] æœªè§£é”ï¼šè¿”å›locked=trueã€price_credits=5

#### 6. äºŒæ¬¡åˆ›ä½œ
- [ ] **äºŒåˆ›æ¥å£**
  - [ ] `POST /works/{work_id}/remix`
  - [ ] å‚æ•°ï¼šprompt_deltaï¼ˆå¯é€‰ï¼‰ã€duration_secã€ratioã€modelã€project_id
  - [ ] **æ‰£è´¹é¡ºåºï¼ˆå¼ºåˆ¶ï¼‰**ï¼š
    ```python
    # 1. å…ˆæ‰£äºŒåˆ›è´¹2ç§¯åˆ†
    credit_wallet.balance -= 2
    credit_ledger.create(type="remix_spend", amount=-2)
    
    # åŸä½œè€…æ”¶å…¥90%ï¼Œå†»ç»“7å¤©
    creator_coins = 2 * 0.9 * 0.05
    coin_ledger.create(
        type="creator_remix_income",
        amount_coins=creator_coins,
        status="pending",
        unlock_at=now() + 7days
    )
    
    # 2. å†åˆ›å»ºç”Ÿæˆä»»åŠ¡ï¼ˆæ‰£10/15/25ï¼‰
    # æ‹¼æ¥promptï¼šåŸprompt + prompt_delta
    final_prompt = work.prompt_text + " " + prompt_delta
    task = create_task(prompt=final_prompt, source_type="remix", source_id=work_id)
    ```

#### 7. æ”¶è—åŠŸèƒ½
- [ ] **æ”¶è—/å–æ¶ˆæ”¶è—**
  - [ ] `POST /works/{work_id}/favorite`
  - [ ] `DELETE /works/{work_id}/favorite`
  - [ ] æ›´æ–°WorkStatsï¼šfavorite_count
- [ ] **æˆ‘çš„æ”¶è—åˆ—è¡¨**
  - [ ] æ¥å£ï¼š`GET /me/favorites?cursor=`
  - [ ] è¿”å›ï¼šæ”¶è—çš„ä½œå“åˆ—è¡¨ï¼ˆå¸¦åˆ›ä½œè€…ä¿¡æ¯ï¼‰
- [ ] **èµ„äº§é¡µæ”¶è—Tab**
  - [ ] å¤ç”¨`/me/favorites`æ¥å£
  - [ ] æ˜¾ç¤ºåœ¨èµ„äº§é¡µ

#### 8. ç‚¹èµåŠŸèƒ½
- [ ] **ç‚¹èµ/å–æ¶ˆç‚¹èµ**
  - [ ] `POST /works/{work_id}/like`
  - [ ] `POST /works/{work_id}/unlike`
  - [ ] åˆ›å»º/åˆ é™¤Likeè®°å½•
  - [ ] æ›´æ–°WorkStatsï¼šlike_count
  - [ ] æ›´æ–°UserStatsï¼šlikes_received_countï¼ˆåˆ›ä½œè€…ï¼‰
- [ ] **ç‚¹èµä¸è¿›èµ„äº§**ï¼ˆåªç”¨äºæ¨èç®—æ³•ï¼‰

### éªŒæ”¶æ ‡å‡†
- âœ… èƒ½ä»èµ„äº§é¡µä¸€é”®å‘å¸ƒä½œå“
- âœ… é¦–é¡µå‘ç°é¡µèƒ½çœ‹åˆ°ä½œå“æµ
- âœ… èƒ½ç‚¹èµã€æ‰“èµå¹¶æ”¶è—ã€åˆ†äº«ä½œå“
- âœ… æ‰“èµååˆ›ä½œè€…é‡‘å¸å†»ç»“7å¤©
- âœ… èƒ½è§£é”æç¤ºè¯ï¼ˆä¸€æ¬¡ä»˜è´¹æ°¸ä¹…æŸ¥çœ‹ï¼‰
- âœ… èƒ½äºŒæ¬¡åˆ›ä½œï¼ˆå…ˆæ‰£2ç§¯åˆ†ç»™åŸä½œè€…ï¼Œå†æ‰£ç”Ÿæˆè´¹ï¼‰
- âœ… èƒ½å…³æ³¨/å–å…³ç”¨æˆ·
- âœ… ç‚¹å‡»å¤´åƒè¿›å…¥ç”¨æˆ·ä¸»é¡µï¼Œçœ‹åˆ°ä½œå“åˆ—è¡¨
- âœ… æ”¶è—çš„ä½œå“è¿›å…¥èµ„äº§é¡µæ”¶è—Tab

---

## Phase 3ï¼šç•™å­˜ä¸å˜ç°å¢å¼ºï¼ˆ14-21å¤©ï¼‰ğŸ’°

### ç›®æ ‡
ç¨³å®šè¿è¥ã€æå‡å¤è´­ã€å»ºç«‹æ¿€åŠ±ç³»ç»Ÿ

### ä½ ä¼šçœ‹åˆ°çš„æˆæœ
âœ… äº§å“å¼€å§‹ç¨³å®šè·‘"ç•™å­˜ + æ”¶å…¥ + æ¿€åŠ±"

### å¼€å‘ä»»åŠ¡æ¸…å•

#### 1. ç§¯åˆ†å……å€¼
- [ ] **å•†å“åˆ—è¡¨**
  - [ ] æ¥å£ï¼š`GET /products?type=credits_pack`
  - [ ] è¿”å›å……å€¼æ¡£ä½ï¼ˆ6å…ƒ/30å…ƒ/68å…ƒ...ï¼‰
- [ ] **åˆ›å»ºæ”¯ä»˜å•**
  - [ ] `POST /payments/create`
  - [ ] å‚æ•°ï¼šproduct_idã€pay_channelï¼ˆwechat/alipayï¼‰
  - [ ] è°ƒç”¨æ”¯ä»˜ç½‘å…³ç”Ÿæˆé¢„ä»˜å•
  - [ ] è¿”å›ï¼špayment_idã€pay_paramsï¼ˆå‰ç«¯æ‹‰èµ·æ”¯ä»˜ç”¨ï¼‰
- [ ] **æ”¯ä»˜å›è°ƒï¼ˆæœåŠ¡ç«¯ï¼‰**
  - [ ] `POST /payments/callback`
  - [ ] éªŒè¯ç­¾å
  - [ ] æ›´æ–°æ”¯ä»˜å•çŠ¶æ€ï¼šsuccess
  - [ ] **å‘æ”¾ç§¯åˆ†**ï¼š
    ```python
    credits = product.credits_amount
    credit_wallet.balance += credits
    credit_ledger.create(type="recharge", amount=+credits, ref_id=payment_id)
    ```

#### 2. æœˆå¡
- [ ] **æœˆå¡å•†å“**
  - [ ] `GET /products?type=subscription_monthly`
  - [ ] è¿”å›æœˆå¡å•†å“ï¼ˆ29å…ƒï¼‰
- [ ] **è´­ä¹°æœˆå¡**
  - [ ] `POST /subscriptions/buy`
  - [ ] åˆ›å»ºæ”¯ä»˜å•
  - [ ] æ”¯ä»˜æˆåŠŸååˆ›å»ºSubscriptionï¼š
    ```python
    Subscription.create(
        user_id=user_id,
        product_id=product_id,
        start_at=now(),
        end_at=now() + 30days,
        status="active"
    )
    ```
- [ ] **æœˆå¡çŠ¶æ€æŸ¥è¯¢**
  - [ ] `GET /subscriptions/me`
  - [ ] è¿”å›ï¼šactive_subscriptionï¼ˆstart/end/days_remaining/today_claimedï¼‰
- [ ] **æ¯æ—¥é¢†å–**
  - [ ] `POST /subscriptions/claim_daily`
  - [ ] **æ£€æŸ¥è§„åˆ™**ï¼š
    ```python
    # 1. å¿…é¡»æœ‰activeçš„subscription
    if not subscription or subscription.status != "active":
        raise SubscriptionNotActive
    
    # 2. ä»Šå¤©ä¸èƒ½å·²é¢†å–
    if DailyRewardClaim.exists(user_id, today):
        raise AlreadyClaimed
    
    # 3. å‘æ”¾30ç§¯åˆ†
    credit_wallet.balance += 30
    credit_ledger.create(type="subscription_daily_bonus", amount=+30)
    DailyRewardClaim.create(user_id, subscription_id, claim_date=today, credits_amount=30)
    ```
- [ ] **æˆ‘çš„é¡µæ˜¾ç¤º**
  - [ ] æœˆå¡çŠ¶æ€å¡ç‰‡
  - [ ] ä»Šæ—¥å¯é¢†/å·²é¢†æç¤º

#### 3. ä»»åŠ¡ä¸­å¿ƒ
- [ ] **ä»»åŠ¡å®šä¹‰è¡¨**
  - [ ] åˆ›å»º`task_definitions`è¡¨
  - [ ] æ’å…¥ä»»åŠ¡æ•°æ®ï¼š
    ```python
    TaskDefinition.create(
        task_key="login_daily",
        title="æ¯æ—¥ç™»å½•",
        description="æ¯å¤©ç™»å½•å³å¯é¢†å–",
        reward_credits=2,
        category="active",
        is_repeatable=True
    )
    # åŒç†ï¼šgen_successã€publish_workã€like_workã€follow_userã€tip_and_favoriteç­‰
    ```
- [ ] **æ¯æ—¥ä»»åŠ¡åˆ†é…ï¼ˆ0ç‚¹å®šæ—¶ä»»åŠ¡ï¼‰**
  - [ ] Celeryå®šæ—¶ä»»åŠ¡ï¼šæ¯å¤©0ç‚¹æ‰§è¡Œ
  - [ ] ä¸ºæ‰€æœ‰ç”¨æˆ·åˆ†é…3ä¸ªä»»åŠ¡ï¼š
    ```python
    # 1ä¸ªæ´»è·ƒç±»ï¼ˆlogin_dailyå›ºå®šï¼‰
    # 1ä¸ªåˆ›ä½œç±»ï¼ˆgen_success/publish_work/remix_workéšæœºï¼‰
    # 1ä¸ªäº’åŠ¨ç±»ï¼ˆlike_work/follow_user/tip_and_favoriteéšæœºï¼‰
    
    DailyTaskAssignment.create(
        user_id=user_id,
        task_key=task_key,
        assign_date=today,
        status="pending"
    )
    ```
- [ ] **ä»Šæ—¥ä»»åŠ¡åˆ—è¡¨**
  - [ ] æ¥å£ï¼š`GET /tasks_center/today`
  - [ ] è¿”å›ï¼š3ä¸ªä»»åŠ¡ï¼ˆtask_keyã€titleã€descriptionã€rewardã€statusï¼‰
- [ ] **ä»»åŠ¡å®Œæˆæ£€æµ‹ï¼ˆäº‹ä»¶é©±åŠ¨ï¼‰**
  - [ ] ç”¨æˆ·ç™»å½• â†’ æ›´æ–°login_dailyä¸ºcompleted
  - [ ] ä»»åŠ¡ç”ŸæˆæˆåŠŸ â†’ æ›´æ–°gen_successä¸ºcompleted
  - [ ] å‘å¸ƒä½œå“ â†’ æ›´æ–°publish_workä¸ºcompleted
  - [ ] ç‚¹èµ â†’ æ›´æ–°like_workä¸ºcompleted
  - [ ] å…³æ³¨ â†’ æ›´æ–°follow_userä¸ºcompleted
  - [ ] æ‰“èµå¹¶æ”¶è— â†’ æ›´æ–°tip_and_favoriteä¸ºcompleted
- [ ] **é¢†å–ä»»åŠ¡å¥–åŠ±**
  - [ ] `POST /tasks_center/claim`
  - [ ] å‚æ•°ï¼štask_key
  - [ ] **å‘æ”¾2ç§¯åˆ†**ï¼š
    ```python
    if assignment.status != "completed":
        raise TaskNotCompleted
    
    credit_wallet.balance += 2
    credit_ledger.create(type="bonus", amount=+2, ref=task_key)
    assignment.status = "claimed"
    assignment.claimed_at = now()
    ```

#### 4. æ‰“èµæ’è¡Œæ¦œ
- [ ] **æ’è¡Œæ¦œæ¥å£**
  - [ ] `GET /rankings/creators/tips?limit=10`
  - [ ] ç»Ÿè®¡åˆ›ä½œè€…ç´¯è®¡æ”¶åˆ°çš„æ‰“èµç§¯åˆ†
  - [ ] æ’åºï¼šorder by total_tipped_credits DESC
  - [ ] è¿”å›ï¼šrankã€user_idã€nicknameã€avatarã€total_tipped_creditsã€followers_count
- [ ] **é¦–é¡µæ’è¡ŒTab**
  - [ ] å¤ç”¨æ’è¡Œæ¦œæ¥å£
  - [ ] æ˜¾ç¤ºTop10

#### 5. é‡‘å¸æç°
- [ ] **å†»ç»“é‡Šæ”¾å®šæ—¶ä»»åŠ¡**
  - [ ] Celeryå®šæ—¶ä»»åŠ¡ï¼šæ¯å°æ—¶æ‰§è¡Œ
  - [ ] æŸ¥è¯¢unlock_at <= now() ä¸” status=pendingçš„è®°å½•
  - [ ] é‡Šæ”¾å†»ç»“é‡‘å¸ï¼š
    ```python
    coin_wallet.pending_coins -= ledger.amount_coins
    coin_wallet.available_coins += ledger.amount_coins
    ledger.status = "settled"
    ```
- [ ] **æç°ç”³è¯·**
  - [ ] `POST /withdrawals/create`
  - [ ] å‚æ•°ï¼šamount_cnyï¼ˆ>=100ï¼‰ã€methodï¼ˆbank_card/alipay/wechatï¼‰ã€account_info
  - [ ] **æ£€æŸ¥ä½™é¢**ï¼š
    ```python
    if coin_wallet.available_coins < amount_cny:
        raise InsufficientCoins
    ```
  - [ ] **æ‰£é™¤é‡‘å¸**ï¼š
    ```python
    coin_wallet.available_coins -= amount_cny
    coin_ledger.create(type="withdraw", amount=-amount_cny, status="settled")
    ```
  - [ ] **åˆ›å»ºæç°å•**ï¼š
    ```python
    Withdrawal.create(
        user_id=user_id,
        amount_cny=amount_cny,
        amount_coins=amount_cny,
        method=method,
        account_info=account_info,
        status="applied"
    )
    ```
- [ ] **æç°è®°å½•**
  - [ ] `GET /withdrawals/me?cursor=`
  - [ ] è¿”å›ï¼šæç°å•åˆ—è¡¨ï¼ˆstatusã€amountã€methodã€created_atã€processed_atï¼‰
- [ ] **åå°å®¡æ ¸**ï¼ˆå¯é€‰ï¼‰
  - [ ] åå°ç®¡ç†ç•Œé¢å®¡æ ¸æç°å•
  - [ ] å®¡æ ¸é€šè¿‡ï¼šstatus=approved â†’ paid
  - [ ] æ‹’ç»ï¼šstatus=rejectedï¼Œé€€å›é‡‘å¸

#### 6. æ¨å¹¿å‘˜ç³»ç»Ÿ
- [ ] **æ¿€æ´»æ¨å¹¿å‘˜**
  - [ ] `POST /promoter/activate`
  - [ ] åˆ›å»º30å…ƒæ”¯ä»˜å•
  - [ ] æ”¯ä»˜æˆåŠŸåï¼š
    ```python
    # 1. å‘æ”¾600ç§¯åˆ†
    credit_wallet.balance += 600
    credit_ledger.create(type="bonus", amount=+600, description="æˆä¸ºæ¨å¹¿å‘˜å¥–åŠ±")
    
    # 2. ç”Ÿæˆæ¨å¹¿ç 
    code = generate_code()  # å¦‚SKY2025ABC
    ReferralCode.create(code=code, promoter_user_id=user_id)
    
    # 3. è®¾ç½®æ¨å¹¿å‘˜æ ‡è¯†
    user.is_promoter = True
    ```
- [ ] **æ¨å¹¿å‘˜ä¿¡æ¯**
  - [ ] `GET /promoter/me`
  - [ ] è¿”å›ï¼šreferral_codeã€promo_creditsã€statsï¼ˆtotal_invitesã€total_commission_coinsï¼‰
- [ ] **ç»‘å®šé‚€è¯·ç **
  - [ ] `POST /referrals/bind`
  - [ ] å‚æ•°ï¼šcode
  - [ ] **æ–°ç”¨æˆ·å¥–åŠ±ï¼ˆåªèƒ½ç»‘å®šä¸€æ¬¡ï¼‰**ï¼š
    ```python
    if ReferralBinding.exists(new_user_id):
        raise AlreadyBound
    
    # ç»‘å®š
    ReferralBinding.create(
        referral_code=code,
        promoter_user_id=promoter_id,
        new_user_id=new_user_id
    )
    
    # æ–°ç”¨æˆ·å¥–åŠ±50ç§¯åˆ†
    credit_wallet.balance += 50
    credit_ledger.create(type="bonus", amount=+50, description="æ–°ç”¨æˆ·é‚€è¯·å¥–åŠ±")
    ```
- [ ] **ç›´æ¥åˆ†ä½£ï¼ˆ5%ï¼Œå®æ—¶ï¼‰**
  - [ ] åœ¨å……å€¼å›è°ƒä¸­è§¦å‘ï¼š
    ```python
    # æŸ¥è¯¢æ˜¯å¦æœ‰æ¨å¹¿å…³ç³»
    binding = ReferralBinding.get(new_user_id)
    if binding:
        # æ¨å¹¿å‘˜è·å¾—5%ä½£é‡‘ï¼ˆé‡‘å¸ï¼‰
        commission_coins = payment.amount_cny * 0.05
        coin_wallet.pending_coins += commission_coins
        coin_ledger.create(
            type="referral_commission_income",
            amount_coins=commission_coins,
            source_user_id=new_user_id,
            status="pending",
            unlock_at=now() + 7days
        )
    ```
- [ ] **äºŒçº§æœˆç»“ï¼ˆ0.1%ï¼Œæ¯æœˆ1å·è·‘æ‰¹ï¼‰**
  - [ ] Celeryå®šæ—¶ä»»åŠ¡ï¼šæ¯æœˆ1å·æ‰§è¡Œ
  - [ ] æŸ¥è¯¢äºŒçº§æ¨å¹¿å…³ç³»å¹¶è®¡ç®—ä½£é‡‘
  - [ ] å‘æ”¾é‡‘å¸ï¼ˆåŒæ ·å†»ç»“7å¤©ï¼‰

### éªŒæ”¶æ ‡å‡†
- âœ… èƒ½å……å€¼ç§¯åˆ†ï¼ˆé€‰æ‹©æ¡£ä½ã€æ”¯ä»˜ã€åˆ°è´¦ï¼‰
- âœ… èƒ½è´­ä¹°æœˆå¡ï¼ˆ29å…ƒï¼‰
- âœ… æœˆå¡ç”¨æˆ·æ¯å¤©èƒ½æ‰‹åŠ¨é¢†å–30ç§¯åˆ†
- âœ… ä»»åŠ¡ä¸­å¿ƒæ¯å¤©åˆ·æ–°3ä¸ªä»»åŠ¡
- âœ… å®Œæˆä»»åŠ¡åèƒ½é¢†å–2ç§¯åˆ†å¥–åŠ±
- âœ… æ’è¡Œæ¦œæ˜¾ç¤ºæ‰“èµTop10åˆ›ä½œè€…
- âœ… é‡‘å¸å†»ç»“7å¤©åè‡ªåŠ¨é‡Šæ”¾åˆ°å¯æç°ä½™é¢
- âœ… æ»¡100å…ƒèƒ½ç”³è¯·æç°
- âœ… å……å€¼30å…ƒèƒ½æˆä¸ºæ¨å¹¿å‘˜ï¼Œè·å¾—600ç§¯åˆ†å’Œé‚€è¯·ç 
- âœ… æ–°ç”¨æˆ·ç»‘å®šé‚€è¯·ç è·å¾—50ç§¯åˆ†
- âœ… æ¨å¹¿å‘˜è·å¾—ç›´æ¥åˆ†ä½£5%ï¼ˆå®æ—¶ï¼Œå†»ç»“7å¤©ï¼‰

---

## Phase 4ï¼šå•†å•ç³»ç»Ÿï¼ˆåæœŸï¼‰ğŸ’¼

### ç›®æ ‡
å¹³å°å‹èƒ½åŠ›ï¼Œå“ç‰Œæ–¹å‘å•ã€åˆ›ä½œè€…æ¥å•ã€äº¤ä»˜éªŒæ”¶ã€æ‰˜ç®¡æ”¾æ¬¾

### ä½ ä¼šçœ‹åˆ°çš„æˆæœ
âœ… å•†ä¸šé—­ç¯
âœ… å¹³å°GMVå¢é•¿

### å¼€å‘ä»»åŠ¡æ¸…å•

#### 1. å•†å•å‘å¸ƒ
- [ ] **é‡‘å¸å……å€¼ï¼ˆå‘å¸ƒè€…ä¸“ç”¨ï¼‰**
  - [ ] `GET /products?type=coins_pack`
  - [ ] `POST /coins/recharge/create_payment`
  - [ ] æ”¯ä»˜æˆåŠŸåå‘æ”¾é‡‘å¸åˆ°`coins_available`
- [ ] **å‘å¸ƒå•†å•**
  - [ ] `POST /orders/create`
  - [ ] å‚æ•°ï¼štitleã€briefã€categoryã€deadline_atã€budget_coins
  - [ ] **å†»ç»“æ‰˜ç®¡é‡‘å¸**ï¼š
    ```python
    if coin_wallet.available_coins < budget_coins:
        raise InsufficientCoins
    
    # å†»ç»“
    coin_wallet.available_coins -= budget_coins
    coin_ledger.create(type="order_escrow_hold", amount=-budget_coins)
    
    # åˆ›å»ºæ‰˜ç®¡
    Escrow.create(order_id, amount=budget_coins, status="held")
    ```
- [ ] **å•†å•åˆ—è¡¨**
  - [ ] `GET /orders/list?status=&cursor=`
  - [ ] ç­›é€‰ï¼špublished/awarded/completed/cancelled

#### 2. æ¥å•æµç¨‹
- [ ] **å•†å•è¯¦æƒ…**
  - [ ] `GET /orders/{order_id}`
  - [ ] è¿”å›ï¼štitleã€briefã€budgetã€deadlineã€publisherã€applicantsï¼ˆç”³è¯·åˆ—è¡¨ï¼‰
- [ ] **ç”³è¯·æ¥å•**
  - [ ] `POST /orders/{order_id}/apply`
  - [ ] å‚æ•°ï¼šproposal_textï¼ˆæ–¹æ¡ˆè¯´æ˜ï¼‰
- [ ] **é€‰å®šä¸­æ ‡è€…**
  - [ ] `POST /orders/{order_id}/award`
  - [ ] å‚æ•°ï¼šcreator_user_id
  - [ ] è®¢å•çŠ¶æ€ï¼šawarded

#### 3. äº¤ä»˜ä¸éªŒæ”¶
- [ ] **äº¤ä»˜ä½œå“**
  - [ ] `POST /orders/{order_id}/deliver`
  - [ ] å‚æ•°ï¼šwork_id
  - [ ] åˆ›å»ºDeliveryè®°å½•
- [ ] **éªŒæ”¶å¹¶æ”¾æ¬¾**
  - [ ] `POST /orders/{order_id}/accept`
  - [ ] **æ”¾æ¬¾é€»è¾‘ï¼ˆå¹³å°æŠ½æˆ5%ï¼‰**ï¼š
    ```python
    fee = budget * 0.05
    payout = budget - fee
    
    # å¹³å°æ”¶å…¥
    coin_ledger.create(type="order_platform_fee_income", amount=+fee, status="pending", unlock_at=now()+7days)
    
    # åˆ›ä½œè€…æ”¶å…¥ï¼ˆå†»ç»“7å¤©ï¼‰
    coin_wallet.pending_coins += payout
    coin_ledger.create(
        type="order_payout_income",
        amount_coins=payout,
        status="pending",
        unlock_at=now() + 7days
    )
    
    # é‡Šæ”¾æ‰˜ç®¡
    Escrow.status = "released"
    ```

#### 4. å–æ¶ˆä¸é€€æ¬¾
- [ ] **å‘èµ·å–æ¶ˆç”³è¯·**
  - [ ] `POST /orders/{order_id}/cancel_request`
  - [ ] è®¢å•çŠ¶æ€ï¼šcancel_requested
- [ ] **åˆ›ä½œè€…åŒæ„/æ‹’ç»**
  - [ ] `POST /orders/{order_id}/cancel_decide`
  - [ ] å‚æ•°ï¼šdecisionï¼ˆapprove/rejectï¼‰
  - [ ] åŒæ„ â†’ é€€å›æ‰˜ç®¡ç»™å‘å¸ƒè€…
  - [ ] æ‹’ç» â†’ ä¿æŒè®¢å•çŠ¶æ€

### éªŒæ”¶æ ‡å‡†
- âœ… å‘å¸ƒè€…èƒ½å……å€¼é‡‘å¸
- âœ… èƒ½å‘å¸ƒå•†å•å¹¶å†»ç»“é¢„ç®—
- âœ… åˆ›ä½œè€…èƒ½æµè§ˆå•†å•å¹¶ç”³è¯·
- âœ… å‘å¸ƒè€…èƒ½é€‰å®šä¸­æ ‡è€…
- âœ… åˆ›ä½œè€…èƒ½äº¤ä»˜ä½œå“
- âœ… å‘å¸ƒè€…éªŒæ”¶åè‡ªåŠ¨æ”¾æ¬¾ï¼ˆæ‰£é™¤5%å¹³å°è´¹ï¼‰
- âœ… åˆ›ä½œè€…æ”¶å…¥å†»ç»“7å¤©åå¯æç°
- âœ… æœªé€‰äººå‰å¯ç›´æ¥å–æ¶ˆé€€æ¬¾
- âœ… å·²é€‰äººæœªäº¤ä»˜éœ€åˆ›ä½œè€…åŒæ„æ‰èƒ½å–æ¶ˆ

---

## é™„å½•ï¼šå…³é”®æŠ€æœ¯ç‚¹é€ŸæŸ¥

### 1. ç§¯åˆ†æ‰£è´¹ä¸‰æ­¥æ³•ï¼ˆç”Ÿæˆä»»åŠ¡ï¼‰
```python
# Step 1: é¢„æ‰£ç§¯åˆ†
credit_wallet.balance -= cost
credit_ledger.create(type="gen_hold", amount=-cost)

# Step 2: åˆ›å»ºä»»åŠ¡
task = Task.create(status="QUEUED", cost_credits=cost)

# Step 3a: æˆåŠŸ â†’ é¢„æ‰£è§†ä¸ºå·²æ‰£ï¼ˆä¸é€€æ¬¾ï¼‰
task.status = "SUCCESS"

# Step 3b: å¤±è´¥ â†’ é€€å›ç§¯åˆ†
credit_wallet.balance += cost
credit_ledger.create(type="gen_refund", amount=+cost)
```

### 2. åˆ›ä½œè€…æ”¶ç›Šå†»ç»“ï¼ˆ7å¤©ï¼‰
```python
# æ‰€æœ‰åˆ›ä½œè€…æ”¶å…¥éƒ½èµ°è¿™ä¸ªæµç¨‹
coin_wallet.pending_coins += amount_coins
coin_ledger.create(
    type="creator_xxx_income",  # tip/prompt/remix/order
    amount_coins=amount_coins,
    status="pending",
    unlock_at=now() + 7days
)

# 7å¤©åå®šæ—¶ä»»åŠ¡é‡Šæ”¾
coin_wallet.pending_coins -= amount_coins
coin_wallet.available_coins += amount_coins
coin_ledger.status = "settled"
```

### 3. æ— æ°´å°ä¸‹è½½å®‰å…¨æ ¡éªŒ
```python
# åç«¯ä»£ç†æ¥å£
@app.post("/assets/videos/{video_id}/download_no_watermark")
def download_no_watermark(video_id, current_user):
    video = VideoAsset.get(video_id)
    
    # 1. æƒé™æ ¡éªŒ
    if video.owner_user_id != current_user.id:
        raise PermissionDenied("åªèƒ½ä¸‹è½½è‡ªå·±çš„è§†é¢‘")
    
    # 2. æ‰£è´¹6ç§¯åˆ†
    credit_wallet.balance -= 6
    credit_ledger.create(type="download_spend", amount=-6)
    
    # 3. ç”Ÿæˆä¸´æ—¶ç­¾åURLï¼ˆä¸è¿”å›ç›´é“¾ï¼‰
    signed_url = generate_signed_url(video.source_no_wm_url, expire=3600)
    
    return {"download_url": signed_url, "expire_at": now() + 1h}
```

### 4. ä¾›åº”å•†ä»»åŠ¡çŠ¶æ€è½®è¯¢
```python
# Celeryå®šæ—¶ä»»åŠ¡ï¼šæ¯30ç§’æ‰«æä¸€æ¬¡QUEUED/IN_PROGRESSä»»åŠ¡
@celery.task
def poll_vendor_tasks():
    tasks = Task.filter(status__in=["QUEUED", "IN_PROGRESS"])
    for task in tasks:
        vendor_state = adapter.get_task_state(task.vendor_task_id)
        
        if vendor_state.status == "SUCCESS":
            # åˆ›å»ºè§†é¢‘èµ„äº§
            VideoAsset.create(
                owner_user_id=task.owner_user_id,
                task_id=task.task_id,
                watermarked_play_url=vendor_state.video_url,
                source_no_wm_url=vendor_state.video_url
            )
            task.status = "SUCCESS"
        
        elif vendor_state.status == "FAILURE":
            # é€€å›ç§¯åˆ†
            credit_wallet.balance += task.cost_credits
            credit_ledger.create(type="gen_refund", amount=+task.cost_credits)
            task.status = "FAILURE"
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0
**æœ€åæ›´æ–°**ï¼š2025-12-25
**è´Ÿè´£äºº**ï¼šSkyRiffäº§å“å›¢é˜Ÿ
