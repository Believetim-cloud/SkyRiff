# 最近更新日志 (Session Changelog)

## 1. 核心修复：视频播放与下载体验
针对国内网络环境连接海外供应商不稳定（导致播放卡顿、下载失败）的问题，实施了**“本地代理 + 自动缓存”**方案。

### 后端改动 (Backend)
*   **`backend/app/vendors/dyuapi_sora2.py`**: 
    *   修复状态映射，兼容 `succeeded`, `finished` 等状态，解决进度条卡在 99% 的问题。
    *   增加详细的调试日志。
*   **`backend/app/api/assets.py`**:
    *   新增 `GET /videos/{video_id}/stream` 接口：支持流式传输代理，解决 CORS 跨域和播放卡顿。
    *   优化 `GET /videos/{video_id}/download` 接口：强制文件下载，不再弹出空白页。
    *   支持通过 URL Query 参数 (`?token=...`) 进行鉴权，适配 `<video>` 标签。
*   **`backend/app/services/task_service.py`**:
    *   新增 `_download_and_cache_video` 方法：视频生成后自动下载到本地服务器 (`backend/static/videos/`)。
    *   优化 `get_task_status`：任务完成时自动触发本地缓存。
*   **`backend/app/main.py`**:
    *   挂载 `/static` 目录，用于直接服务本地缓存的视频文件。

### 前端改动 (Frontend)
*   **`src/app/services/backend-api.ts`**:
    *   新增 `getVideoStreamUrl`：智能生成播放链接（优先走后端代理）。
    *   优化 `downloadVideoFile`：使用 Blob 方式下载，体验更丝滑。
*   **`src/app/components/AssetsPage.tsx`**:
    *   **播放器优化**：所有视频播放链接替换为 `getVideoStreamUrl`，确保秒开。
    *   **下载优化**：点击下载按钮直接触发文件保存，不再跳转。
    *   **错误修复**：修复了 `showToast` 调用报错的问题。
    *   **状态处理**：增强了对“任务失败”状态的识别和提示。

## 2. 依赖与配置
*   **`backend/app/api/dependencies.py`**:
    *   更新 `get_current_user`：支持从 Query 参数中读取 Token，解决视频流鉴权问题。

---
*Generated by SkyRiff AI Assistant*
